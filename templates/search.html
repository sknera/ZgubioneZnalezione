{% extends "base.html" %}

{% block content %}
<div class="search-container">
    <div class="search-header">
        <h2>Baza Znalezionych Przedmiot贸w</h2>
        <form id="searchForm" class="search-filters" action="{{ url_for('search') }}" method="GET" role="search">
            <div class="search-main">
                <label for="q" class="visually-hidden" style="position:absolute; left:-9999px">Szukaj</label>
                <input type="text" id="q" name="q" placeholder="Wpisz nazw lub opis przedmiotu..."
                    value="{{ request.args.get('q', '') }}">
                <button type="submit" class="search-btn">Szukaj</button>
            </div>
            <div class="filter-row">
                <div class="form-group">
                    <label for="category-filter">Kategoria</label>
                    <select id="category-filter" name="category">
                        <option value="">-- Wszystkie --</option>
                        {% for cat in categories %}
                        <option value="{{ cat }}" {% if request.args.get('category')==cat %}selected{% endif %}>{{ cat
                            }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label for="location-filter">Lokalizacja</label>
                    <input type="text" id="location-filter" name="location" placeholder="Miejscowo/Ulica"
                        value="{{ request.args.get('location', '') }}">
                </div>
                <div class="form-group">
                    <label for="date-filter">Data</label>
                    <input type="date" id="date-filter" name="date" value="{{ request.args.get('date', '') }}">
                </div>
            </div>

            <input type="hidden" name="circle_lat" id="circle_lat" value="{{ request.args.get('circle_lat', '') }}">
            <input type="hidden" name="circle_lng" id="circle_lng" value="{{ request.args.get('circle_lng', '') }}">
            <input type="hidden" name="circle_radius" id="circle_radius"
                value="{{ request.args.get('circle_radius', '') }}">

            <div class="map-filter-card">
                <div class="map-filter-header">
                    <div>
                        <h3>Przybli偶ona lokalizacja zgubienia</h3>
                        <p class="map-hint">Niebieskie kropki pokazuj, gdzie zwykle zgaszane s przedmioty. U偶yj
                            domylnego narzdzia rysowania koa, aby zawzi wyniki do wskazanego obszaru.</p>
                    </div>
                    <button type="button" class="ghost-btn" id="clearCircleBtn">Wyczy obszar</button>
                </div>
                <div id="searchMap" aria-label="Mapa do zaznaczenia przybli偶onej lokalizacji"></div>
                <div class="map-status-row">
                    <span id="activeAreaInfo" class="map-status">
                        {% if request.args.get('circle_radius') %}
                        Aktywny filtr obszaru: promie {{ request.args.get('circle_radius')|float|round(0) }} m
                        {% else %}
                        Brak aktywnego filtra obszaru
                        {% endif %}
                    </span>
                </div>
            </div>
        </form>
    </div>

    {% if items %}
    <div class="items-grid" role="list">
        {% for item in items %}
        <div class="item-card" role="listitem">
            <div class="item-info">
                <div class="item-header">
                    <span class="category-tag">{{ item.category }}</span>
                    <span class="date-tag">Znaleziono: {{ item.date }}</span>
                </div>
                <h3>{{ item.name }}</h3>
                <p class="location"><strong>Lokalizacja:</strong> {{ item.location }}</p>
                <p class="description">{{ item.description }}</p>
            </div>
            <div class="item-actions">
                <button class="contact-btn"
                    onclick="openClaimModal('{{ item.id }}', '{{ item.security_question }}', {{ item.security_answer_examples|default([])|tojson }})">
                    Zgo roszczenie
                </button>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="empty-state">
        <div class="icon" aria-hidden="true"></div>
        <h3>Brak wynik贸w</h3>
        <p>Nie znaleziono przedmiot贸w speniajcych kryteria wyszukiwania.</p>
        <a href="{{ url_for('index') }}" class="cta-btn">Zgo Nowe Znalezisko</a>
    </div>
    {% endif %}
</div>

<!-- Claim Modal -->
<div id="claimModal" class="modal" hidden role="dialog" aria-labelledby="modal-title" aria-modal="true">
    <div class="modal-content">
        <button class="close-modal" onclick="closeClaimModal()" aria-label="Zamknij okno">&times;</button>
        <h2 id="modal-title">Weryfikacja Wasnoci</h2>
        <p>Aby skontaktowa si ze znalazc, musisz poprawnie odpowiedzie na pytanie weryfikacyjne.</p>

        <div class="question-box">
            <strong>Pytanie od znalazcy:</strong>
            <div id="modalQuestion" style="font-size: 1.1em; margin-top: 5px;"></div>
            <div id="modalExamples" style="margin-top:8px; color:#444; font-size:0.95em;"></div>
        </div>

        <form id="claimForm">
            <input type="hidden" id="claimItemId">
            <div class="form-group">
                <label for="claimAnswer">Twoja Odpowied藕 *</label>
                <input type="text" id="claimAnswer" required aria-required="true"
                    placeholder="Wpisz szczeg贸ow odpowied藕...">
            </div>
            <button type="submit" class="submit-btn">Wylij Zgoszenie</button>
        </form>
    </div>
</div>

<script id="map-points-data" type="application/json">{{ map_points | tojson }}</script>
<script id="circle-params" type="application/json">{{ circle_params | tojson }}</script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const mapPointsEl = document.getElementById('map-points-data');
        const mapPoints = mapPointsEl ? JSON.parse(mapPointsEl.textContent || '[]') : [];
        const circleParamsEl = document.getElementById('circle-params');
        const circleParams = circleParamsEl ? JSON.parse(circleParamsEl.textContent || '{}') : {};

        const form = document.getElementById('searchForm');
        const latInput = document.getElementById('circle_lat');
        const lngInput = document.getElementById('circle_lng');
        const radiusInput = document.getElementById('circle_radius');
        const clearBtn = document.getElementById('clearCircleBtn');
        const statusLabel = document.getElementById('activeAreaInfo');

        const defaultCenter = [52.40637, 16.92517]; // Pozna
        const hasCircle = circleParams && circleParams.lat != null && circleParams.lng != null && circleParams.radius;
        const initialCenter = hasCircle
            ? [circleParams.lat, circleParams.lng]
            : (mapPoints.length
                ? [mapPoints.reduce((sum, p) => sum + p.lat, 0) / mapPoints.length, mapPoints.reduce((sum, p) => sum + p.lng, 0) / mapPoints.length]
                : defaultCenter);
        const initialZoom = hasCircle ? 13 : 12;

        const map = L.map('searchMap').setView(initialCenter, initialZoom);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        // Show dots with where items are usually lost
        const markerLayer = L.layerGroup().addTo(map);
        mapPoints.forEach(point => {
            L.circleMarker([point.lat, point.lng], {
                radius: 6,
                color: '#003399',
                fillColor: '#4F46E5',
                fillOpacity: 0.6
            }).bindPopup(`<strong>${point.name}</strong><br>${point.category || ''}<br>${point.date || ''}`).addTo(markerLayer);
        });

        const drawnItems = new L.FeatureGroup().addTo(map);
        const drawControl = new L.Control.Draw({
            draw: {
                polygon: false,
                rectangle: false,
                polyline: false,
                marker: false,
                circlemarker: false,
                circle: {
                    shapeOptions: { color: '#003399', fillOpacity: 0.12, weight: 2 }
                }
            },
            edit: {
                featureGroup: drawnItems,
                edit: false,
                remove: true
            }
        });
        map.addControl(drawControl);

        function setStatus(text) {
            if (statusLabel) statusLabel.textContent = text;
        }

        function clearCircleInputs() {
            latInput.value = '';
            lngInput.value = '';
            radiusInput.value = '';
        }

        map.on(L.Draw.Event.CREATED, function (e) {
            drawnItems.clearLayers();
            drawnItems.addLayer(e.layer);
            const center = e.layer.getLatLng();
            const radius = e.layer.getRadius();
            latInput.value = center.lat.toFixed(6);
            lngInput.value = center.lng.toFixed(6);
            radiusInput.value = Math.round(radius);
            setStatus(`Aktywny filtr obszaru: promie ${Math.round(radius)} m`);
            map.fitBounds(e.layer.getBounds());
            form.submit();
        });

        map.on(L.Draw.Event.DELETED, function () {
            clearCircleInputs();
            setStatus('Brak aktywnego filtra obszaru');
            form.submit();
        });

        if (hasCircle) {
            const circle = L.circle([circleParams.lat, circleParams.lng], {
                radius: circleParams.radius,
                color: '#003399',
                fillOpacity: 0.12,
                weight: 2
            });
            drawnItems.addLayer(circle);
            map.fitBounds(circle.getBounds());
            setStatus(`Aktywny filtr obszaru: promie ${Math.round(circleParams.radius)} m`);
        }

        clearBtn?.addEventListener('click', () => {
            drawnItems.clearLayers();
            clearCircleInputs();
            setStatus('Brak aktywnego filtra obszaru');
            form.submit();
        });
    });
</script>
{% endblock %}